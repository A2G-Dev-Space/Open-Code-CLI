generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 사용자 모델
model User {
  id         String   @id @default(uuid())
  loginid    String   @unique
  username   String
  deptname   String   @default("")
  firstSeen  DateTime @default(now())
  lastActive DateTime @default(now())
  isActive   Boolean  @default(true)

  usageLogs       UsageLog[]
  dailyUsageStats DailyUsageStat[]
  feedbacks       Feedback[]

  @@map("users")
}

// LLM 모델 설정
model Model {
  id          String   @id @default(uuid())
  name        String   @unique
  displayName String
  endpointUrl String
  apiKey      String?
  maxTokens   Int      @default(128000)
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  createdBy   String?

  creator    Admin?     @relation(fields: [createdBy], references: [id])
  usageLogs  UsageLog[]
  dailyUsageStats DailyUsageStat[]

  @@map("models")
}

// 관리자
model Admin {
  id        String   @id @default(uuid())
  loginid   String   @unique
  role      AdminRole @default(ADMIN)
  createdAt DateTime @default(now())

  models    Model[]
  responses Feedback[]  // 답변한 피드백들

  @@map("admins")
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  VIEWER
}

// 사용 로그 (개별 요청)
model UsageLog {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  modelId      String   @map("model_id")
  inputTokens  Int      @default(0)
  outputTokens Int      @default(0)
  totalTokens  Int      @default(0)
  timestamp    DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id])
  model Model @relation(fields: [modelId], references: [id])

  @@index([userId])
  @@index([modelId])
  @@index([timestamp])
  @@map("usage_logs")
}

// 일별 사용 통계 (집계)
model DailyUsageStat {
  id                String   @id @default(uuid())
  date              DateTime @db.Date
  userId            String   @map("user_id")
  modelId           String   @map("model_id")
  deptname          String   @default("")
  totalInputTokens  Int      @default(0)
  totalOutputTokens Int      @default(0)
  requestCount      Int      @default(0)

  user  User  @relation(fields: [userId], references: [id])
  model Model @relation(fields: [modelId], references: [id])

  @@unique([date, userId, modelId])
  @@index([date])
  @@index([userId])
  @@index([modelId])
  @@map("daily_usage_stats")
}

// 피드백 카테고리
enum FeedbackCategory {
  ISSUE           // 버그/문제 신고
  FEATURE         // 기능 제안
  QUESTION        // 질문/도움
  DOCS            // 문서 개선
  PERFORMANCE     // 성능 이슈
  OTHER           // 기타
}

// 피드백 상태
enum FeedbackStatus {
  OPEN            // 새 피드백
  IN_PROGRESS     // 검토 중
  RESOLVED        // 해결됨
  CLOSED          // 종료
}

// 피드백
model Feedback {
  id          String           @id @default(uuid())
  userId      String           @map("user_id")
  category    FeedbackCategory
  title       String
  content     String
  images      String[]         @default([])  // 이미지 데이터 (base64)
  status      FeedbackStatus   @default(OPEN)
  response    String?          // 관리자 답변
  respondedBy String?          @map("responded_by")  // 답변한 관리자 ID
  respondedAt DateTime?        @map("responded_at")
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  user      User   @relation(fields: [userId], references: [id])
  responder Admin? @relation(fields: [respondedBy], references: [id])

  @@index([userId])
  @@index([status])
  @@index([category])
  @@index([createdAt])
  @@map("feedbacks")
}
